# Hetzner VPS Deployment Guide

This guide covers deploying the AI Dashboard to a single Hetzner VPS using Docker Compose.

## Prerequisites

### VPS Setup
- Hetzner VPS running Ubuntu 22.04 LTS (or similar)
- At least 2GB RAM, 20GB storage
- SSH access to your VPS
- Domain name (optional, but recommended for HTTPS)

### Required Software
- Docker & Docker Compose
- Git

### Installation

SSH into your VPS and run:

```bash
# Update system packages
sudo apt update && sudo apt upgrade -y

# Install Docker
curl -fsSL https://get.docker.com -o get-docker.sh
sudo sh get-docker.sh

# Add your user to docker group (optional, allows running docker without sudo)
sudo usermod -aG docker $USER
newgrp docker

# Install Docker Compose (comes with Docker Desktop, but verify on VPS)
docker compose --version

# Install Git
sudo apt install -y git

# Clone the repository
cd /opt
git clone <your-repo-url> aidashboard
cd aidashboard
```

## Configuration

### 1. Create Environment File

```bash
cp .env.example .env
nano .env
```

Update the following values:

```env
# Use a secure password (generate with: openssl rand -base64 32)
DB_PASSWORD=your-secure-database-password

# Use a secure secret for ElectricSQL
ELECTRIC_SECRET=your-secure-electric-secret

# Your VPS IP or domain name
# If using IP:
ELECTRIC_URL=http://your-vps-ip:3000

# If using a domain with HTTPS (requires reverse proxy - see below):
ELECTRIC_URL=https://electric.yourdomain.com
```

### 2. Web App Configuration

```bash
cp web/.env.example web/.env
nano web/.env
```

Update:

```env
# Should match the root .env ELECTRIC_URL
PUBLIC_ELECTRIC_URL=http://your-vps-ip:3000
# Or: PUBLIC_ELECTRIC_URL=https://electric.yourdomain.com

ELECTRIC_SECRET=your-secure-electric-secret
```

### 3. Ingestor Configuration (Optional)

The ingestor reads DATABASE_URL from the root `.env` file. No additional configuration needed, but you can customize:

```bash
# In root .env:
INGESTION_INTERVAL_SECS=3600  # How often to fetch new data (seconds)
RUST_LOG=info                  # Logging level (info, debug, warn, error)
```

## Building & Running

### Build Images

```bash
# From project root
docker compose -f docker-compose.prod.yml build
```

### Start Services

```bash
# Start all services in the background
docker compose -f docker-compose.prod.yml up -d

# View logs
docker compose -f docker-compose.prod.yml logs -f

# View specific service logs
docker compose -f docker-compose.prod.yml logs -f electric
docker compose -f docker-compose.prod.yml logs -f ingestor
docker compose -f docker-compose.prod.yml logs -f web
```

### Stop Services

```bash
docker compose -f docker-compose.prod.yml down
```

## Accessing the Application

### Without HTTPS (Direct IP)

1. **Web App**: `http://your-vps-ip:5173`
2. **ElectricSQL**: `http://your-vps-ip:3000`

### With HTTPS (Using Nginx Reverse Proxy)

If you want to use a domain with HTTPS, set up Nginx as a reverse proxy:

```bash
# Install Nginx
sudo apt install -y nginx certbot python3-certbot-nginx

# Create Nginx config (replace yourdomain.com)
sudo tee /etc/nginx/sites-available/aidashboard > /dev/null <<EOF
server {
    listen 80;
    server_name yourdomain.com;

    # Redirect HTTP to HTTPS
    return 301 https://\$server_name\$request_uri;
}

server {
    listen 443 ssl http2;
    server_name yourdomain.com;

    # SSL certificates (auto-generated by certbot)
    ssl_certificate /etc/letsencrypt/live/yourdomain.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/yourdomain.com/privkey.pem;

    # Web app (port 5173)
    location / {
        proxy_pass http://localhost:5173;
        proxy_http_version 1.1;
        proxy_set_header Upgrade \$http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host \$host;
        proxy_set_header X-Real-IP \$remote_addr;
        proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto \$scheme;
    }

    # ElectricSQL (port 3000) - optional, if you want direct access
    location /electric/ {
        proxy_pass http://localhost:3000/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade \$http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host \$host;
    }
}
EOF

# Enable the site
sudo ln -s /etc/nginx/sites-available/aidashboard /etc/nginx/sites-enabled/

# Test Nginx config
sudo nginx -t

# Reload Nginx
sudo systemctl reload nginx

# Get SSL certificate
sudo certbot certonly --nginx -d yourdomain.com

# Auto-renew certificates
sudo systemctl enable certbot.timer
sudo systemctl start certbot.timer
```

Then update your `.env`:

```env
ELECTRIC_URL=https://yourdomain.com
```

And `web/.env`:

```env
PUBLIC_ELECTRIC_URL=https://yourdomain.com
```

Restart the services:

```bash
docker compose -f docker-compose.prod.yml restart electric web
```

## Database Management

### Access PostgreSQL

```bash
# From the VPS, inside the postgres container
docker compose -f docker-compose.prod.yml exec postgres psql -U postgres -d aidashboard
```

### Backup Database

```bash
# Create a backup
docker compose -f docker-compose.prod.yml exec postgres pg_dump -U postgres aidashboard > backup.sql

# Restore from backup
docker compose -f docker-compose.prod.yml exec -T postgres psql -U postgres -d aidashboard < backup.sql
```

### Run Migrations

If you have database migrations:

```bash
# From your local machine or VPS
sqlx migrate run --database-url "postgresql://postgres:password@your-vps-ip:5432/aidashboard"
```

## Monitoring

### Check Service Status

```bash
docker compose -f docker-compose.prod.yml ps
```

### View Resource Usage

```bash
docker stats
```

### Set Up Automatic Restart

The `docker-compose.prod.yml` includes `restart: unless-stopped` for all services, which means they'll automatically restart if they crash or the VPS reboots.

### Logs

```bash
# View all logs
docker compose -f docker-compose.prod.yml logs -f

# View last N lines
docker compose -f docker-compose.prod.yml logs --tail=50

# View logs since a specific time
docker compose -f docker-compose.prod.yml logs --since 10m
```

## Updates & Deployment

### Deploy New Code

```bash
cd /opt/aidashboard

# Pull latest code
git pull origin main

# Rebuild images
docker compose -f docker-compose.prod.yml build

# Restart services (zero-downtime for stateless services)
docker compose -f docker-compose.prod.yml up -d
```

### Zero-Downtime Deploys

The web app and ingestor can be restarted without downtime. PostgreSQL and ElectricSQL should generally stay running, but can be briefly restarted if needed:

```bash
# Restart only web app (no data loss)
docker compose -f docker-compose.prod.yml restart web

# Restart ingestor (no data loss)
docker compose -f docker-compose.prod.yml restart ingestor

# Full restart (brief downtime)
docker compose -f docker-compose.prod.yml restart
```

## Troubleshooting

### Services Won't Start

Check logs:

```bash
docker compose -f docker-compose.prod.yml logs postgres
docker compose -f docker-compose.prod.yml logs electric
docker compose -f docker-compose.prod.yml logs ingestor
docker compose -f docker-compose.prod.yml logs web
```

### Database Connection Issues

Verify DATABASE_URL is correct in `.env`:

```bash
# Should work:
docker compose -f docker-compose.prod.yml exec postgres pg_isready -U postgres
```

### ElectricSQL Not Connecting to Database

Check ElectricSQL logs:

```bash
docker compose -f docker-compose.prod.yml logs electric
```

Ensure PostgreSQL is healthy:

```bash
docker compose -f docker-compose.prod.yml ps postgres
```

### Web App Can't Connect to ElectricSQL

1. Verify `PUBLIC_ELECTRIC_URL` in `web/.env` matches the public URL
2. Ensure port 3000 is accessible (or 443 if using reverse proxy)
3. Check ElectricSQL is running: `docker compose -f docker-compose.prod.yml ps electric`

### Disk Space Issues

```bash
# Check disk usage
df -h

# Clean up unused Docker resources
docker system prune -a

# Check which services are using the most space
docker system df

# Limit postgres data volume size if needed (requires plan ahead)
```

## Performance Tuning

### PostgreSQL

For a 2GB VPS, PostgreSQL defaults are fine. For larger VPS:

Edit `docker-compose.prod.yml` postgres environment:

```yaml
environment:
  # ... other vars
  # Add for 4GB+ RAM:
  # POSTGRES_INITDB_ARGS: "-c shared_buffers=256MB -c effective_cache_size=1GB -c maintenance_work_mem=64MB"
```

### ElectricSQL

Monitor memory usage:

```bash
docker stats aidashboard-electric
```

If consuming too much memory, check connected clients and synced shapes.

## Security Best Practices

1. **Use strong passwords**: Generate with `openssl rand -base64 32`
2. **Limit PostgreSQL access**: Only expose via Docker network
3. **Use HTTPS**: Set up Nginx reverse proxy with Let's Encrypt
4. **Firewall**: Only expose ports 80, 443, and 22 to the internet
5. **Keep software updated**: Regularly pull latest Docker images
6. **Backup regularly**: Set up automated database backups
7. **Monitor logs**: Check logs regularly for errors or suspicious activity

## Maintenance

### Weekly

```bash
# Check logs for errors
docker compose -f docker-compose.prod.yml logs | grep -i error

# Verify all services are running
docker compose -f docker-compose.prod.yml ps
```

### Monthly

```bash
# Update base images
docker pull postgres:16-alpine
docker pull electricsql/electric:latest
docker pull node:22-alpine
docker pull rust:1.84-alpine

# Rebuild and restart
docker compose -f docker-compose.prod.yml build --pull
docker compose -f docker-compose.prod.yml up -d
```

### Backup Database

```bash
# Create daily backup (cron job)
0 2 * * * cd /opt/aidashboard && docker compose -f docker-compose.prod.yml exec -T postgres pg_dump -U postgres aidashboard > /backups/aidashboard-$(date +\%Y\%m\%d).sql
```

## Rollback

If an update causes issues:

```bash
# View running containers
docker ps

# Stop services
docker compose -f docker-compose.prod.yml down

# Restore from git
git checkout <previous-commit-hash>

# Rebuild and restart
docker compose -f docker-compose.prod.yml build
docker compose -f docker-compose.prod.yml up -d
```

## Support

For issues or questions, check:
- Docker Compose logs (see Troubleshooting section)
- GitHub Issues in the project repository
- ElectricSQL documentation: https://electric-sql.com/docs
- SvelteKit documentation: https://kit.svelte.dev
